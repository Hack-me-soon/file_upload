<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GitHub Multi-Uploader</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 50px; background: #f4f4f9; }
        #drop-zone { 
            width: 400px; height: 150px; border: 3px dashed #4A90E2; 
            border-radius: 10px; display: flex; align-items: center; 
            justify-content: center; background: white; cursor: pointer;
        }
        #file-list { margin-top: 20px; width: 400px; }
        .file-item { 
            background: #eee; margin: 5px 0; padding: 8px; 
            border-radius: 4px; font-size: 0.9em; display: flex; justify-content: space-between;
        }
        #status { margin-top: 20px; font-weight: bold; }
        .progress { color: #666; font-size: 0.8em; }
    </style>
</head>
<body>

    <h2>Multi-File Uploader</h2>
    <div id="drop-zone">Drag & Drop Multiple Files or Click</div>
    <input type="file" id="fileInput" multiple hidden>
    
    <div id="file-list"></div>
    
    <p>Press <strong>Enter</strong> to upload all files</p>
    <div id="status"></div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        const fileListDisplay = document.getElementById('file-list');
        const status = document.getElementById('status');
        
        let selectedFiles = [];

        dropZone.onclick = () => fileInput.click();
        
        fileInput.onchange = (e) => handleFiles(e.target.files);

        // Global Drag Listeners
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(name => {
            window.addEventListener(name, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        window.addEventListener('drop', (e) => {
            handleFiles(e.dataTransfer.files);
        });

        function handleFiles(files) {
            // Convert FileList to Array and add to our selection
            const newFiles = Array.from(files);
            selectedFiles = [...selectedFiles, ...newFiles];
            renderFileList();
        }

        function renderFileList() {
            fileListDisplay.innerHTML = selectedFiles.map((f, i) => `
                <div class="file-item">
                    <span>${f.name}</span>
                    <span class="progress">Ready</span>
                </div>
            `).join('');
            status.innerText = `${selectedFiles.length} files selected.`;
        }

        window.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && selectedFiles.length > 0) {
                uploadAllFiles();
            }
        });

        async function uploadAllFiles() {
            const total = selectedFiles.length;
            status.innerText = `Starting upload of ${total} files...`;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const item = fileListDisplay.children[i];
                const progressSpan = item.querySelector('.progress');

                try {
                    await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        const formData = new FormData();
                        formData.append('file', file);

                        // Track Progress
                        xhr.upload.addEventListener('progress', (e) => {
                            if (e.lengthComputable) {
                                const percent = Math.round((e.loaded / e.total) * 100);
                                progressSpan.innerText = `Uploading: ${percent}%`;
                            }
                        });

                        xhr.onreadystatechange = () => {
                            if (xhr.readyState === 4) {
                                if (xhr.status === 200) resolve();
                                else reject(new Error("Upload failed with status " + xhr.status));
                            }
                        };

                        xhr.open('POST', '/upload', true);
                        xhr.send(formData);
                    });

                    progressSpan.innerText = "✅ Done";
                    progressSpan.style.color = "green";
                } catch (err) {
                    progressSpan.innerText = "❌ Failed: " + err.message;
                    progressSpan.style.color = "red";
                }
            }
            status.innerText = "All processing finished.";
            selectedFiles = [];
        }
    </script>
</body>
</html>