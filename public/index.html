<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Protocol Uploader</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 50px; 
            background: #f4f7f9; 
            color: #333;
        }
        h2 { color: #2c3e50; }
        #drop-zone { 
            width: 450px; 
            height: 180px; 
            border: 3px dashed #4A90E2; 
            border-radius: 15px; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            background: white; 
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            padding: 10px;
        }
        #drop-zone:hover { background: #edf2f7; border-color: #357abd; }
        #file-list { margin-top: 25px; width: 450px; }
        .file-item { 
            background: #ffffff; 
            margin: 8px 0; 
            padding: 12px; 
            border-radius: 8px; 
            font-size: 0.9em; 
            display: flex; 
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #4A90E2;
        }
        #status { 
            margin-top: 25px; 
            font-weight: 600; 
            color: #555;
            padding: 10px;
            border-radius: 5px;
        }
        .progress { font-weight: bold; color: #4A90E2; }
        .kb-info { font-size: 0.8em; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

    <h2>Multi-File Git Uploader</h2>
    <div id="drop-zone">
        <strong>Drag & Drop Files Here</strong>
        <span>or click to browse</span>
        <div class="kb-info">(Up to 100MB per file)</div>
    </div>
    
    <input type="file" id="fileInput" multiple hidden>
    
    <div id="file-list"></div>
    
    <p style="margin-top:20px;">Press <strong>Enter</strong> to start the Git Push</p>
    <div id="status">No files selected</div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        const fileListDisplay = document.getElementById('file-list');
        const status = document.getElementById('status');
        
        let selectedFiles = [];

        // Interaction Listeners
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFiles(e.target.files);

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(name => {
            window.addEventListener(name, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        window.addEventListener('drop', (e) => {
            handleFiles(e.dataTransfer.files);
        });

        function handleFiles(files) {
            const newFiles = Array.from(files);
            selectedFiles = [...selectedFiles, ...newFiles];
            renderFileList();
        }

        function renderFileList() {
            if (selectedFiles.length === 0) {
                fileListDisplay.innerHTML = "";
                status.innerText = "No files selected";
                return;
            }
            fileListDisplay.innerHTML = selectedFiles.map((f, i) => `
                <div class="file-item">
                    <span>${f.name} <small>(${(f.size / (1024*1024)).toFixed(2)} MB)</small></span>
                    <span class="progress" id="prog-${i}">Ready</span>
                </div>
            `).join('');
            status.innerText = `${selectedFiles.length} files prepared for upload.`;
        }

        window.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && selectedFiles.length > 0) {
                uploadAllFiles();
            }
        });

        async function uploadAllFiles() {
            const filesToUpload = [...selectedFiles];
            selectedFiles = []; 
            status.innerText = "Starting sequential upload...";

            for (let i = 0; i < filesToUpload.length; i++) {
                const file = filesToUpload[i];
                const item = fileListDisplay.children[i];
                const progressSpan = item.querySelector('.progress');

                try {
                progressSpan.innerText = "Processing...";
                
                await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    const formData = new FormData();
                    formData.append('file', file);

                    xhr.onreadystatechange = () => {
                        if (xhr.readyState === 4) {
                            // If status is 0, it means the server restarted/crashed
                            if (xhr.status === 200) resolve();
                            else reject(new Error("Server restarted or timed out"));
                        }
                    };

                    xhr.open('POST', '/upload', true);
                    xhr.timeout = 240000; 
                    xhr.send(formData);
                });

                progressSpan.innerText = "✅ Done";
            } catch (err) {
                // Check GitHub anyway, the server might have finished before the restart!
                progressSpan.innerText = "⚠️ Check GitHub (Server Restarted)";
                progressSpan.style.color = "orange";
            }

            // ALWAYS wait 10 seconds before the next file to let the server recover
            await new Promise(r => setTimeout(r, 10000));
            }
            status.innerText = "Batch complete.";
        }
    </script>
</body>
</html>