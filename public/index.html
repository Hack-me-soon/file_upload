<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Protocol Uploader</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 50px; 
            background: #f4f7f9; 
            color: #333;
        }
        h2 { color: #2c3e50; }
        #drop-zone { 
            width: 450px; 
            height: 180px; 
            border: 3px dashed #4A90E2; 
            border-radius: 15px; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            background: white; 
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            padding: 10px;
        }
        #drop-zone:hover { background: #edf2f7; border-color: #357abd; }
        #file-list { margin-top: 25px; width: 450px; }
        .file-item { 
            background: #ffffff; 
            margin: 8px 0; 
            padding: 12px; 
            border-radius: 8px; 
            font-size: 0.9em; 
            display: flex; 
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #4A90E2;
        }
        #status { 
            margin-top: 25px; 
            font-weight: 600; 
            color: #555;
            padding: 10px;
            border-radius: 5px;
        }
        .progress { font-weight: bold; color: #4A90E2; }
        .kb-info { font-size: 0.8em; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

    <h2>Multi-File Git Uploader</h2>
    <div id="drop-zone">
        <strong>Drag & Drop Files Here</strong>
        <span>or click to browse</span>
        <div class="kb-info">(Up to 100MB per file)</div>
    </div>
    
    <input type="file" id="fileInput" multiple hidden>
    
    <div id="file-list"></div>
    
    <p style="margin-top:20px;">Press <strong>Enter</strong> to start the Git Push</p>
    <div id="status">No files selected</div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        const fileListDisplay = document.getElementById('file-list');
        const status = document.getElementById('status');
        
        let selectedFiles = [];

        // Interaction Listeners
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFiles(e.target.files);

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(name => {
            window.addEventListener(name, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        window.addEventListener('drop', (e) => {
            handleFiles(e.dataTransfer.files);
        });

        function handleFiles(files) {
            const newFiles = Array.from(files);
            selectedFiles = [...selectedFiles, ...newFiles];
            renderFileList();
        }

        function renderFileList() {
            if (selectedFiles.length === 0) {
                fileListDisplay.innerHTML = "";
                status.innerText = "No files selected";
                return;
            }
            fileListDisplay.innerHTML = selectedFiles.map((f, i) => `
                <div class="file-item">
                    <span>${f.name} <small>(${(f.size / (1024*1024)).toFixed(2)} MB)</small></span>
                    <span class="progress" id="prog-${i}">Ready</span>
                </div>
            `).join('');
            status.innerText = `${selectedFiles.length} files prepared for upload.`;
        }

        window.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && selectedFiles.length > 0) {
                uploadAllFiles();
            }
        });

        async function uploadAllFiles() {
            const filesToUpload = [...selectedFiles]; // Snapshot
            selectedFiles = []; // Clear current selection
            status.innerText = "Processing queue...";
            status.style.background = "#e1effe";

            for (let i = 0; i < filesToUpload.length; i++) {
                const file = filesToUpload[i];
                const progressSpan = document.getElementById(`prog-${i}`);
                
                // 2 second cooldown for server RAM/Garbage Collection
                if (i > 0) await new Promise(r => setTimeout(r, 2000)); 

                try {
                    await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        const formData = new FormData();
                        formData.append('file', file);

                        xhr.upload.addEventListener('progress', (e) => {
                            if (e.lengthComputable) {
                                const percent = Math.round((e.loaded / e.total) * 100);
                                progressSpan.innerText = `Uploading: ${percent}%`;
                                if (percent === 100) {
                                    progressSpan.innerText = "Syncing with Git...";
                                    progressSpan.style.color = "#f39c12";
                                }
                            }
                        });

                        xhr.onreadystatechange = () => {
                            if (xhr.readyState === 4) {
                                if (xhr.status === 200 || xhr.status === 202) resolve();
                                else reject(new Error(`Server error: ${xhr.status}`));
                            }
                        };

                        xhr.onerror = () => reject(new Error("Network connection failed."));
                        
                        // 3 minute timeout for large Git Protocol operations
                        xhr.timeout = 180000; 
                        xhr.ontimeout = () => reject(new Error("Request timed out (3 mins)."));

                        xhr.open('POST', '/upload', true);
                        xhr.send(formData);
                    });

                    progressSpan.innerText = "✅ Done";
                    progressSpan.style.color = "#27ae60";

                } catch (err) {
                    console.error(err);
                    progressSpan.innerText = "❌ Failed";
                    progressSpan.style.color = "#c0392b";
                }
            }
            status.innerText = "All uploads completed. Check your GitHub repo!";
            status.style.background = "#d4edda";
        }
    </script>
</body>
</html>